generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String           @id @default(uuid())
  email           String           @unique
  name            String?
  role            UserRole         @default(VIEWER)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  kycStatus       String           @default("pending")
  walletId        String?          @unique
  accountType     String           @default("individual")
  riskScore       Float            @default(0.0)
  verified        Boolean          @default(false)
  assetAuditLogs  AssetAuditLog[]  @relation("AuditReviewer")
  captureSessions CaptureSession[]
  consentRecords  ConsentRecord[]
  earnings        EarningsLedger[]
  orgMemberships  OrgUser[]
  payouts         Payout[]
  profile         Profile?
  sandboxAccount  SandboxAccount?
  annotations     UserAnnotation[]
  contributor     Contributor?
}

model Profile {
  id                 String   @id @default(uuid())
  userId             String   @unique
  username           String?  @unique
  avatarUrl          String?
  bio                String?
  website            String?
  onboardingComplete Boolean  @default(false)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model CaptureSession {
  id           String                   @id @default(uuid())
  userId       String
  sourceType   SourceType               @default(MOBILE)
  deviceId     String?
  startTime    DateTime                 @default(now())
  endTime      DateTime?
  createdAt    DateTime                 @default(now())
  progress     Int                      @default(0)
  status       String                   @default("active")
  user         User                     @relation(fields: [userId], references: [id])
  skillProfile ContributorSkillProfile?
  assets       MediaAsset[]
}

model MediaAsset {
  id                    String                  @id @default(uuid())
  datasetId             String?
  filename              String
  sizeBytes             BigInt
  duration              Float?
  status                MediaStatus             @default(PROCESSING)
  createdAt             DateTime                @default(now())
  checksum              String?
  resolution            String?
  sessionId             String?
  storagePointer        String?
  type                  String
  pipelineJobs          AnnotationPipelineJob[]
  auditLogs             AssetAuditLog[]
  audioQualityMetrics   AudioQualityMetrics?
  compositeQualityScore CompositeQualityScore?
  consent               ConsentRecord?
  earnings              EarningsLedger[]
  extendedFailures      ExtendedFailureEvent[]
  failureRecoveryEvents FailureRecoveryEvent[]
  handPoseDetections    HandPoseDetection[]
  linguisticFeatures    LinguisticFeatures?
  dataset               Dataset?                @relation(fields: [datasetId], references: [id])
  session               CaptureSession?         @relation(fields: [sessionId], references: [id])
  objectDetections      ObjectDetection[]
  preprocessingJobs     PreprocessingJob[]
  provenanceRecords     ProvenanceRecord[]
  sceneSegments         SceneSegment[]
  scriptAlignment       ScriptAlignment?
  speechSegments        SpeechSegment[]
  stagingBinEntry       StagingBinEntry?
  taskComplexity        TaskComplexityMetrics?
  temporalActions       TemporalAction[]
  transcriptSegments    TranscriptSegment[]
  uploadMetadata        UploadMetadata?
  annotations           UserAnnotation[]
  qaScore               AssetQAScore?
}

model AssetAuditLog {
  id         String     @id @default(uuid())
  assetId    String
  stage      String
  result     String
  confidence Float?
  reviewerId String?
  metadata   Json?
  createdAt  DateTime   @default(now())
  asset      MediaAsset @relation(fields: [assetId], references: [id])
  reviewer   User?      @relation("AuditReviewer", fields: [reviewerId], references: [id])
}

model Client {
  id           String   @id @default(uuid())
  name         String
  industry     String?
  tier         String   @default("standard")
  billingEmail String?
  billingPlan  String   @default("usage")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  deals        Deal[]
}

model Deal {
  id           String   @id @default(uuid())
  clientId     String
  datasetIds   String[]
  pricingModel String
  termMonths   Int      @default(12)
  usageLimits  Json?
  slaTier      String   @default("standard")
  status       String   @default("active")
  totalValue   Decimal  @db.Decimal(18, 2)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  client       Client   @relation(fields: [clientId], references: [id])
}

model ConsentRecord {
  id          String     @id @default(uuid())
  userId      String
  mediaId     String     @unique
  licenseType String
  usageScope  Json
  revSharePct Float      @default(50.0)
  timestamp   DateTime   @default(now())
  asset       MediaAsset @relation(fields: [mediaId], references: [id])
  user        User       @relation(fields: [userId], references: [id])
}

model UserAnnotation {
  id          String     @id @default(uuid())
  mediaId     String
  userId      String
  labelType   String
  confidence  Float      @default(1.0)
  timestamp   DateTime   @default(now())
  boundingBox Json?
  endTime     Float?
  labels      String[]
  startTime   Float?
  status      String     @default("pending")
  asset       MediaAsset @relation(fields: [mediaId], references: [id])
  user        User       @relation(fields: [userId], references: [id])
}

model EarningsLedger {
  id        String      @id @default(uuid())
  userId    String
  mediaId   String?
  eventType String
  amount    Decimal     @db.Decimal(18, 8)
  currency  String      @default("USD")
  timestamp DateTime    @default(now())
  asset     MediaAsset? @relation(fields: [mediaId], references: [id])
  user      User        @relation(fields: [userId], references: [id])
}

model Payout {
  id        String   @id @default(uuid())
  userId    String
  amount    Decimal  @db.Decimal(18, 8)
  method    String
  status    String   @default("pending")
  timestamp DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model Organization {
  id             String          @id @default(uuid())
  name           String
  industry       String?
  billingPlan    String          @default("free")
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  apiKeys        APICredential[]
  adProjects     AdProject[]
  datasets       DatasetAccess[]
  builds         DatasetBuild[]
  invoices       Invoice[]
  members        OrgUser[]
  outreachAssets OutreachAsset[]
  usage          UsageRecord[]
}

model OrgUser {
  id     String       @id @default(uuid())
  userId String
  orgId  String
  role   OrgRole      @default(ANALYST)
  org    Organization @relation(fields: [orgId], references: [id])
  user   User         @relation(fields: [userId], references: [id])
}

model Dataset {
  id                  String                     @id @default(uuid())
  name                String
  version             String
  description         String?
  createdAt           DateTime                   @default(now())
  updatedAt           DateTime                   @updatedAt
  annotationSchema    Json?
  licenseTerms        String?
  mediaType           String
  ragEnabled          Boolean                    @default(false)
  annotationTypes     String[]
  benchmarkResults    Json?
  datasetStatus       DatasetStatus              @default(DRAFT)
  governanceProfileId String?
  intendedUseCases    String[]
  isAnchor            Boolean                    @default(false)
  licenseType         LicenseType                @default(COMMERCIAL)
  modalities          String[]
  modelReadinessScore Float?
  pricingModel        PricingModel               @default(USAGE)
  qualityProfileId    String?
  totalHours          Float?
  vertical            DatasetVertical            @default(OTHER)
  annotationEvents    AnnotationEvent[]
  governanceProfile   GovernanceProfile?         @relation(fields: [governanceProfileId], references: [id])
  qualityProfile      QualityProfile?            @relation(fields: [qualityProfileId], references: [id])
  access              DatasetAccess[]
  autoSummary         DatasetAutoSummary?
  commercialMetadata  DatasetCommercialMetadata?
  manifests           DatasetManifest[]
  mediaAssets         MediaAsset[]
  outreachAssets      OutreachAsset[]
  submissions         Submission[]
  qaScore             DatasetQAScore?
}

model DatasetAccess {
  id         String       @id @default(uuid())
  orgId      String
  datasetId  String
  accessType String
  expiresAt  DateTime?
  dataset    Dataset      @relation(fields: [datasetId], references: [id])
  org        Organization @relation(fields: [orgId], references: [id])
}

model DatasetBuild {
  id           String       @id @default(uuid())
  orgId        String
  sourceAssets Json
  filters      Json?
  ragRules     Json?
  status       String       @default("queued")
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  org          Organization @relation(fields: [orgId], references: [id])
}

model AdProject {
  id        String            @id @default(uuid())
  name      String
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  status    String            @default("draft")
  goal      String
  orgId     String
  platform  String
  runs      AdGenerationRun[]
  org       Organization      @relation(fields: [orgId], references: [id])
}

model AdGenerationRun {
  id            String    @id @default(uuid())
  projectId     String
  promptVersion String
  model         String
  outputAssets  Json?
  metrics       Json?
  createdAt     DateTime  @default(now())
  project       AdProject @relation(fields: [projectId], references: [id])
}

model APICredential {
  id        String       @id @default(uuid())
  orgId     String
  apiKey    String       @unique
  scope     String
  rateLimit Int          @default(1000)
  createdAt DateTime     @default(now())
  org       Organization @relation(fields: [orgId], references: [id])
}

model UsageRecord {
  id        String       @id @default(uuid())
  orgId     String
  service   String
  units     Int
  cost      Decimal      @db.Decimal(10, 4)
  timestamp DateTime     @default(now())
  org       Organization @relation(fields: [orgId], references: [id])
}

model Invoice {
  id        String       @id @default(uuid())
  orgId     String
  amount    Decimal      @db.Decimal(10, 2)
  period    String
  status    String       @default("unpaid")
  createdAt DateTime     @default(now())
  org       Organization @relation(fields: [orgId], references: [id])
}

model Blog {
  id        String   @id @default(uuid())
  slug      String   @unique
  title     String
  content   String
  excerpt   String?
  author    String?
  thumbnail String?
  published Boolean  @default(false)
  category  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SeoPage {
  id          String   @id @default(uuid())
  slug        String   @unique
  title       String
  h1          String?
  description String?
  content     Json?
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model GovernanceProfile {
  id                     String    @id @default(uuid())
  name                   String
  consentSource          String
  usageRights            String[]
  geographicRestrictions String[]
  dataRetentionPolicy    String    @default("indefinite")
  auditLogEnabled        Boolean   @default(true)
  complianceTags         String[]
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt
  datasets               Dataset[]
}

model QualityProfile {
  id                      String    @id @default(uuid())
  name                    String
  annotationConfidenceAvg Float     @default(0)
  interAnnotatorAgreement Float     @default(0)
  reviewPassRate          Float     @default(0)
  benchmarkTasks          String[]
  lastAuditAt             DateTime?
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  datasets                Dataset[]
}

model AnnotationEvent {
  id            String   @id @default(uuid())
  datasetId     String
  annotatorType String
  confidence    Float    @default(1.0)
  reviewed      Boolean  @default(false)
  version       String
  metadata      Json?
  createdAt     DateTime @default(now())
  dataset       Dataset  @relation(fields: [datasetId], references: [id])
}

model SystemAuditLog {
  id         String   @id @default(uuid())
  action     String
  actorId    String?
  resourceId String?
  details    Json?
  ipAddress  String?
  status     String
  timestamp  DateTime @default(now())
}

model OutreachAsset {
  id          String        @id @default(uuid())
  datasetId   String?
  orgId       String?
  type        String
  format      String
  url         String
  generatedAt DateTime      @default(now())
  dataset     Dataset?      @relation(fields: [datasetId], references: [id])
  org         Organization? @relation(fields: [orgId], references: [id])
}

model DatasetRevenueLedger {
  id           String   @id @default(uuid())
  datasetId    String
  buyerType    String
  buyerOrgId   String?
  usageUnits   Int
  priceUsd     Decimal  @db.Decimal(18, 2)
  revenueShare Json
  notes        String?
  createdAt    DateTime @default(now())
}

model SandboxAccount {
  id                String   @id @default(uuid())
  userId            String   @unique
  apiKeyScope       String[]
  rateLimit         Int      @default(100)
  datasetsPreloaded String[]
  expiresAt         DateTime
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model QuickstartProject {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  description String?
  type        String
  datasetId   String?
  steps       String[]
  difficulty  String   @default("beginner")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Tutorial {
  id            String   @id @default(uuid())
  title         String
  slug          String   @unique
  summary       String?
  datasetsUsed  String[]
  tools         String[]
  estimatedTime String
  content       String
  published     Boolean  @default(false)
  order         Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model EndpointDoc {
  id             String   @id @default(uuid())
  endpoint       String   @unique
  method         String
  description    String
  parameters     Json?
  examples       Json
  avgLatencyMs   Float?
  commonUseCases String[]
  tags           String[]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model ContractTemplate {
  id          String              @id @default(uuid())
  type        String
  name        String
  description String?
  content     String
  variables   String[]
  isActive    Boolean             @default(true)
  version     String              @default("1.0")
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  contracts   GeneratedContract[]
}

model GeneratedContract {
  id             String           @id @default(uuid())
  templateId     String
  orgId          String?
  datasetId      String?
  variables      Json
  content        String
  status         String           @default("draft")
  signedAt       DateTime?
  signedByUserId String?
  expiresAt      DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  template       ContractTemplate @relation(fields: [templateId], references: [id])
}

model UserMemory {
  id             String    @id @default(uuid())
  userId         String    @unique
  staticContext  Json      @default("{}")
  dynamicContext Json      @default("{}")
  searchPatterns String[]
  preferredTypes String[]
  topDatasets    String[]
  totalQueries   Int       @default(0)
  avgQueryDepth  Float     @default(2.0)
  lastQueryAt    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
}

model MemoryEvent {
  id         String    @id @default(uuid())
  userId     String?
  entityId   String
  entityType String
  content    String
  embedding  Float[]
  weight     Float     @default(1.0)
  reinforced Int       @default(0)
  metadata   Json?
  source     String?
  expiresAt  DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@index([userId])
  @@index([entityType])
  @@index([createdAt])
}

model LabDataset {
  id          String         @id @default(uuid())
  title       String
  description String?
  category    String
  price       Float
  isPublic    Boolean        @default(false)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  videos      LabeledVideo[]
}

model LabeledVideo {
  id          String            @id @default(uuid())
  datasetId   String
  filename    String
  url         String
  duration    Int
  status      String
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  dataset     LabDataset        @relation(fields: [datasetId], references: [id])
  annotations VideoAnnotation[]
}

model VideoAnnotation {
  id          String       @id @default(uuid())
  videoId     String
  timestamp   Float
  label       String
  action      String?
  confidence  Float
  boundingBox Json?
  createdAt   DateTime     @default(now())
  video       LabeledVideo @relation(fields: [videoId], references: [id])
}

model UploadMetadata {
  id                   String               @id @default(uuid())
  mediaAssetId         String               @unique
  uploaderId           String
  datasetType          DatasetType
  deviceModel          String
  recordingEnvironment RecordingEnvironment
  consentSigned        Boolean              @default(true)
  rightsGranted        Boolean              @default(true)
  country              String               @db.Char(2)
  uploadTimestamp      DateTime             @default(now())
  originalFilename     String
  originalSizeBytes    BigInt
  originalHash         String
  ipRegion             String?
  createdAt            DateTime             @default(now())
  mediaAsset           MediaAsset           @relation(fields: [mediaAssetId], references: [id], onDelete: Cascade)

  @@index([uploaderId])
  @@index([datasetType])
}

model PreprocessingJob {
  id           String            @id @default(uuid())
  mediaAssetId String
  jobType      PreprocessingType
  status       JobStatus         @default(QUEUED)
  progress     Int               @default(0)
  inputPath    String
  outputPath   String?
  metrics      Json?
  startedAt    DateTime?
  completedAt  DateTime?
  errorMessage String?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  mediaAsset   MediaAsset        @relation(fields: [mediaAssetId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([mediaAssetId])
}

model HandPoseDetection {
  id           String     @id @default(uuid())
  mediaAssetId String
  frameId      Int
  timestampMs  Float
  handId       HandType
  keypoints    Json
  confidence   Float
  modelName    String     @default("mediapipe_hands")
  modelVersion String     @default("0.10.0")
  createdAt    DateTime   @default(now())
  mediaAsset   MediaAsset @relation(fields: [mediaAssetId], references: [id], onDelete: Cascade)

  @@index([mediaAssetId])
  @@index([frameId])
}

model ObjectDetection {
  id           String     @id @default(uuid())
  mediaAssetId String
  frameId      Int
  timestampMs  Float
  objectType   String
  bbox         Json
  confidence   Float
  category     String?
  orientation  Json?
  pieceId      String?
  modelName    String     @default("yolov8")
  modelVersion String     @default("8.0.0")
  createdAt    DateTime   @default(now())
  mediaAsset   MediaAsset @relation(fields: [mediaAssetId], references: [id], onDelete: Cascade)

  @@index([mediaAssetId])
  @@index([frameId])
  @@index([objectType])
}

model TemporalAction {
  id            String       @id @default(uuid())
  mediaAssetId  String
  startMs       Float
  endMs         Float
  action        ActionLabel
  confidence    Float
  metadata      Json?
  modelName     String       @default("timesformer")
  modelVersion  String       @default("1.0.0")
  humanReviewed Boolean      @default(false)
  humanLabel    ActionLabel?
  reviewedBy    String?
  reviewedAt    DateTime?
  createdAt     DateTime     @default(now())
  mediaAsset    MediaAsset   @relation(fields: [mediaAssetId], references: [id], onDelete: Cascade)

  @@index([mediaAssetId])
  @@index([action])
}

model FailureRecoveryEvent {
  id              String      @id @default(uuid())
  mediaAssetId    String
  timestampMs     Float
  failureType     FailureType
  recoveryAction  String?
  confidence      Float
  detectionMethod String      @default("hybrid")
  modelName       String?
  modelVersion    String?
  humanVerified   Boolean     @default(false)
  verifiedBy      String?
  verifiedAt      DateTime?
  createdAt       DateTime    @default(now())
  mediaAsset      MediaAsset  @relation(fields: [mediaAssetId], references: [id], onDelete: Cascade)

  @@index([mediaAssetId])
  @@index([failureType])
}

model SceneSegment {
  id           String     @id @default(uuid())
  mediaAssetId String
  stepId       String     @default(uuid())
  startMs      Float
  endMs        Float
  description  String?
  sceneType    String?
  modelName    String     @default("pyscenedetect")
  modelVersion String     @default("0.6.0")
  createdAt    DateTime   @default(now())
  mediaAsset   MediaAsset @relation(fields: [mediaAssetId], references: [id], onDelete: Cascade)

  @@index([mediaAssetId])
}

model SpeechSegment {
  id           String     @id @default(uuid())
  mediaAssetId String
  startMs      Float
  endMs        Float
  isSpeech     Boolean    @default(true)
  speakerId    String?
  modelName    String     @default("pyannote_vad")
  modelVersion String     @default("3.0.0")
  createdAt    DateTime   @default(now())
  mediaAsset   MediaAsset @relation(fields: [mediaAssetId], references: [id], onDelete: Cascade)

  @@index([mediaAssetId])
  @@index([speakerId])
}

model TranscriptSegment {
  id               String     @id @default(uuid())
  mediaAssetId     String
  text             String
  startMs          Float
  endMs            Float
  confidence       Float
  wordTimings      Json?
  language         String     @default("en")
  accent           String?
  accentConfidence Float?
  modelName        String     @default("whisper")
  modelVersion     String     @default("large-v3")
  humanCorrected   Boolean    @default(false)
  correctedText    String?
  correctedBy      String?
  correctedAt      DateTime?
  createdAt        DateTime   @default(now())
  mediaAsset       MediaAsset @relation(fields: [mediaAssetId], references: [id], onDelete: Cascade)

  @@index([mediaAssetId])
  @@index([language])
}

model AudioQualityMetrics {
  id           String     @id @default(uuid())
  mediaAssetId String     @unique
  snrDb        Float
  noiseLevel   NoiseLevel
  clipping     Boolean    @default(false)
  peakDb       Float?
  avgDb        Float?
  dynamicRange Float?
  createdAt    DateTime   @default(now())
  mediaAsset   MediaAsset @relation(fields: [mediaAssetId], references: [id], onDelete: Cascade)
}

model CompositeQualityScore {
  id                   String     @id @default(uuid())
  mediaAssetId         String     @unique
  clarityScore         Float
  annotationConfidence Float
  stabilityScore       Float
  complianceScore      Float
  overallScore         Float
  isPremiumQuality     Boolean    @default(false)
  excludedFromDatasets Boolean    @default(false)
  calculatedAt         DateTime   @default(now())
  modelVersions        Json?
  mediaAsset           MediaAsset @relation(fields: [mediaAssetId], references: [id], onDelete: Cascade)
}

model DatasetManifest {
  id               String   @id @default(uuid())
  datasetId        String
  version          String
  hours            Float
  contributorCount Int
  assetCount       Int
  annotationTypes  String[]
  modalities       String[]
  manifestJson     Json
  changeType       String?
  previousVersion  String?
  changelog        String?
  createdAt        DateTime @default(now())
  dataset          Dataset  @relation(fields: [datasetId], references: [id], onDelete: Cascade)

  @@unique([datasetId, version])
  @@index([datasetId])
}

model ProvenanceRecord {
  id                String     @id @default(uuid())
  mediaAssetId      String
  originalHash      String
  originalFilename  String
  originalSizeBytes BigInt
  contributorId     String
  agreementId       String?
  uploadTimestamp   DateTime
  ipRegion          String?
  deviceFingerprint String?
  annotationModels  Json
  annotationRuns    Json?
  accessLog         Json?
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  mediaAsset        MediaAsset @relation(fields: [mediaAssetId], references: [id], onDelete: Cascade)

  @@index([mediaAssetId])
  @@index([contributorId])
}

model AnnotationPipelineJob {
  id               String       @id @default(uuid())
  mediaAssetId     String
  pipelineType     PipelineType
  status           JobStatus    @default(QUEUED)
  progress         Int          @default(0)
  currentStage     String?
  stagesCompleted  String[]     @default([])
  annotationCounts Json?
  startedAt        DateTime?
  completedAt      DateTime?
  errorMessage     String?
  retryCount       Int          @default(0)
  maxRetries       Int          @default(3)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  mediaAsset       MediaAsset   @relation(fields: [mediaAssetId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([mediaAssetId])
}

model DatasetCommercialMetadata {
  id                      String   @id @default(uuid())
  datasetId               String   @unique
  intendedUse             String[]
  notSuitableFor          String[]
  trainingReadinessScore  Float
  estimatedModelGain      String?
  knownBiases             String[]
  containsFailureRecovery Boolean  @default(false)
  longHorizonSequences    Boolean  @default(false)
  humanSkillVariance      Boolean  @default(false)
  rightsCleared           Boolean  @default(true)
  multiViewCapture        Boolean  @default(false)
  temporalConsistency     Boolean  @default(true)
  trainSplit              Float    @default(0.7)
  validationSplit         Float    @default(0.15)
  testSplit               Float    @default(0.15)
  splitMethod             String   @default("by_contributor")
  canAddContributors      Boolean  @default(true)
  canAddObjectIdentity    Boolean  @default(true)
  canAddMultiView         Boolean  @default(false)
  canAddLongerSessions    Boolean  @default(true)
  oneLiner                String?
  bestFor                 String[]
  notFor                  String[]
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  dataset                 Dataset  @relation(fields: [datasetId], references: [id], onDelete: Cascade)
}

model ContributorSkillProfile {
  id                  String         @id @default(uuid())
  sessionId           String         @unique
  estimatedSkillLevel SkillLevel
  inferenceMethod     String         @default("action_speed_variance_plus_error_rate")
  confidence          Float
  avgActionDuration   Float?
  errorRate           Float?
  recoveryEfficiency  Float?
  skillProgression    Json?
  createdAt           DateTime       @default(now())
  session             CaptureSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
}

model ActionNormalization {
  id                String   @id @default(uuid())
  canonicalAction   String
  rawVariants       String[]
  mappingConfidence Float
  datasetScope      String?
  occurrenceCount   Int      @default(0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([canonicalAction, datasetScope])
}

model TaskComplexityMetrics {
  id                   String     @id @default(uuid())
  mediaAssetId         String     @unique
  totalSteps           Int
  branchingFactor      Int
  avgStepDurationMs    Float
  complexityScore      Float
  longestSequence      Int?
  failureRecoveryCount Int?
  createdAt            DateTime   @default(now())
  mediaAsset           MediaAsset @relation(fields: [mediaAssetId], references: [id], onDelete: Cascade)
}

model ExtendedFailureEvent {
  id                    String              @id @default(uuid())
  mediaAssetId          String
  timestampMs           Float
  failureType           ExtendedFailureType
  severity              FailureSeverity
  humanCorrectionTimeMs Float?
  precedingAction       String?
  recoveryAction        String?
  confidence            Float
  modelName             String?
  modelVersion          String?
  createdAt             DateTime            @default(now())
  mediaAsset            MediaAsset          @relation(fields: [mediaAssetId], references: [id], onDelete: Cascade)

  @@index([mediaAssetId])
  @@index([failureType])
}

model LinguisticFeatures {
  id                   String     @id @default(uuid())
  mediaAssetId         String     @unique
  speechRateWpm        Float
  prosodyVariance      Float
  pronunciationEntropy Float
  avgPauseDurationMs   Float?
  fillerWordRate       Float?
  createdAt            DateTime   @default(now())
  mediaAsset           MediaAsset @relation(fields: [mediaAssetId], references: [id], onDelete: Cascade)
}

model ScriptAlignment {
  id               String     @id @default(uuid())
  mediaAssetId     String     @unique
  expectedTextId   String
  deviations       Int
  alignmentScore   Float
  deviationDetails Json?
  createdAt        DateTime   @default(now())
  mediaAsset       MediaAsset @relation(fields: [mediaAssetId], references: [id], onDelete: Cascade)
}

model DatasetAutoSummary {
  id                   String   @id @default(uuid())
  datasetId            String   @unique
  oneLiner             String
  bestFor              String[]
  notFor               String[]
  totalHours           Float
  totalContributors    Int
  totalAssets          Int
  avgQualityScore      Float?
  failureRecoveryHours Float?
  skillVarianceRange   String?
  generatedAt          DateTime @default(now())
  generationModel      String?
  dataset              Dataset  @relation(fields: [datasetId], references: [id], onDelete: Cascade)
}

model StagingBinEntry {
  id              String        @id @default(uuid())
  mediaAssetId    String        @unique
  status          StagingStatus @default(PENDING)
  reviewerId      String?
  reviewNotes     String?
  qualityScore    Float?
  rejectionReason String?
  annotationJobId String?
  labSchemaOutput Json?
  pdfModuleUrl    String?
  pdfGeneratedAt  DateTime?
  createdAt       DateTime      @default(now())
  reviewedAt      DateTime?
  completedAt     DateTime?
  mediaAsset      MediaAsset    @relation(fields: [mediaAssetId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([reviewerId])
}

enum UserRole {
  ADMIN
  EDITOR
  VIEWER
  CONTRIBUTOR
  ENTERPRISE
}

enum SourceType {
  MOBILE
  GLASSES
  TV
  API
}

enum OrgRole {
  ADMIN
  ANALYST
  CREATIVE
}

enum MediaStatus {
  PROCESSING
  READY
  ERROR
}

enum DatasetVertical {
  AUTOMOTIVE
  BROADCAST
  GAMING
  THERAPY
  RETAIL
  OTHER
}

enum DatasetStatus {
  DRAFT
  PUBLISHED
  DEPRECATED
}

enum LicenseType {
  COMMERCIAL
  RESEARCH
  HYBRID
}

enum PricingModel {
  USAGE
  SUBSCRIPTION
  EXCLUSIVE
}

enum DatasetType {
  LEGO_VIDEO
  AUDIO_SPEECH
  MULTIMODAL
  OTHER
}

enum RecordingEnvironment {
  QUIET
  MODERATE
  NOISY
}

enum PreprocessingType {
  VIDEO_TRANSCODE
  VIDEO_FRAME_EXTRACT
  AUDIO_EXTRACT
  AUDIO_NORMALIZE
  METADATA_EXTRACT
}

enum JobStatus {
  QUEUED
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

enum HandType {
  LEFT
  RIGHT
}

enum ActionLabel {
  SEARCH
  ALIGN
  ATTACH
  DETACH
  ROTATE
  ADJUST
  PAUSE
  INSPECT
  OTHER
}

enum FailureType {
  MISALIGNMENT
  WRONG_PIECE
  DROP
  COLLISION
  STUCK
  OTHER
}

enum NoiseLevel {
  LOW
  MODERATE
  HIGH
}

enum PipelineType {
  VIDEO_FULL
  AUDIO_FULL
  VIDEO_AUDIO_FULL
  VIDEO_OBJECTS_ONLY
  VIDEO_ACTIONS_ONLY
  AUDIO_ASR_ONLY
}

enum SkillLevel {
  NOVICE
  INTERMEDIATE
  EXPERT
}

enum ExtendedFailureType {
  MISALIGNMENT
  WRONG_PIECE
  FORCE_ERROR
  SEQUENCE_ERROR
  DROP
  COLLISION
  STUCK
  OTHER
}

enum FailureSeverity {
  LOW
  MEDIUM
  HIGH
}

enum StagingStatus {
  PENDING
  APPROVED
  REJECTED
  IN_ANNOTATION
  PENDING_REVIEW
  COMPLETED
}

// --- HARBOR CONTRIBUTOR PIPELINE EXTENSIONS ---

enum ContributorStatus {
  APPLIED
  APPROVED
  REJECTED
  SUSPENDED
}

enum ApplicationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ContributorDatasetType {
  LEGO
  AUDIO
}

enum ContributorMediaType {
  VIDEO
  AUDIO
}

enum SubmissionStatus {
  UPLOADED
  PROCESSING
  ANNOTATED
  REVIEWED
}

enum ReviewVerdict {
  APPROVED
  REJECTED
  PARTIAL
}

enum PaymentStatus {
  PENDING
  SCHEDULED
  PAID
}

model Contributor {
  id            String          @id @default(uuid())
  userId        String          @unique
  email         String          @unique
  country       String?
  deviceType    String?
  status        ContributorStatus @default(APPLIED)
  consentSigned Boolean         @default(false)
  appliedAt     DateTime?
  approvedAt    DateTime?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  
  user          User            @relation(fields: [userId], references: [id])
  applications  ContributorApplication[]
  submissions   Submission[]
  payments      ContributorPayment[]
}

model ContributorApplication {
  id               String            @id @default(uuid())
  contributorId    String
  datasetType      ContributorDatasetType
  eligibilityFlags Json?
  adminNotes       String?
  status           ApplicationStatus @default(PENDING)
  submittedAt      DateTime          @default(now())
  reviewedAt       DateTime?
  
  contributor      Contributor       @relation(fields: [contributorId], references: [id])
}

model Submission {
  id              String           @id @default(uuid())
  contributorId   String
  datasetId       String?
  mediaType       ContributorMediaType
  durationSeconds Int?
  resolution      String?
  filePath        String
  uploadStatus    SubmissionStatus @default(UPLOADED)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  
  contributor     Contributor      @relation(fields: [contributorId], references: [id])
  dataset         Dataset?         @relation(fields: [datasetId], references: [id])
  
  autoAnnotations AutoAnnotation[]
  humanReviews    HumanReview[]
  payments        ContributorPayment[]
}

model AutoAnnotation {
  id               String     @id @default(uuid())
  submissionId     String
  modelUsed        String?
  actionLabels     Json?
  objectDetections Json?
  failureEvents    Json?
  qualityScore     Float?
  confidenceScore  Float?
  createdAt        DateTime   @default(now())
  
  submission       Submission @relation(fields: [submissionId], references: [id])
}

model HumanReview {
  id             String        @id @default(uuid())
  submissionId   String
  reviewerId     String?
  verdict        ReviewVerdict
  reviewerNotes  String?
  additionalTags Json?
  reviewedAt     DateTime      @default(now())
  
  submission     Submission    @relation(fields: [submissionId], references: [id])
  reviewer       User?         @relation(fields: [reviewerId], references: [id])
}

model ContributorPayment {
  id            String        @id @default(uuid())
  contributorId String
  submissionId  String
  amountUsd     Float
  status        PaymentStatus @default(PENDING)
  eligibleAt    DateTime?
  paidAt        DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  contributor   Contributor   @relation(fields: [contributorId], references: [id])
  submission    Submission    @relation(fields: [submissionId], references: [id])
}

// --- HARBOR QA SCORING SYSTEM ---

enum AssetQAStatus {
  APPROVED
  NEEDS_REVIEW
  REJECTED
}

enum DatasetQAStatus {
  PRODUCTION_GRADE
  TRAINING_READY
  RESEARCH_ONLY
  NOT_DELIVERABLE
}

model AssetQAScore {
  id                String        @id @default(uuid())
  mediaAssetId      String        @unique
  
  // 5-Component Scoring (0-100 each)
  accuracyScore     Float         @default(0)  // Weight: 35%
  consistencyScore  Float         @default(0)  // Weight: 20%
  technicalScore    Float         @default(0)  // Weight: 20%
  completenessScore Float         @default(0)  // Weight: 15%
  confidenceScore   Float         @default(0)  // Weight: 10%
  
  // Computed Overall
  overallScore      Float         @default(0)  // Weighted sum 0-100
  status            AssetQAStatus @default(NEEDS_REVIEW)
  
  // Critical Failure Handling
  criticalFailure   Boolean       @default(false)
  failureReasons    Json?         // Array of failure reason strings
  
  // Metadata
  reviewedBy        String?
  reviewedAt        DateTime?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  mediaAsset        MediaAsset    @relation(fields: [mediaAssetId], references: [id], onDelete: Cascade)
}

model DatasetQAScore {
  id                  String          @id @default(uuid())
  datasetId           String          @unique
  
  // Aggregate Metrics
  medianAssetScore    Float           @default(0)
  meanAssetScore      Float           @default(0)
  lowQualityPenalty   Float           @default(0)  // % assets below 70
  
  // Computed Overall
  overallScore        Float           @default(0)  // Weighted: 50% median + 30% mean + 20% penalty
  status              DatasetQAStatus @default(NOT_DELIVERABLE)
  
  // Distribution Buckets
  distributionBuckets Json?           // { "90-100": 12, "80-89": 45, "70-79": 30, "<70": 8 }
  totalAssets         Int             @default(0)
  
  // Export Readiness
  exportReady         Boolean         @default(false)
  lastCalculatedAt    DateTime        @default(now())
  
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  
  dataset             Dataset         @relation(fields: [datasetId], references: [id], onDelete: Cascade)
}
